/***************************************************************************//**
  @file     App.c
  @brief    Application functions
  @author   Grupo 5
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/

#include "MK64F12.h"
#include "hardware.h"

#include "Drivers/board.h"
#include "Drivers/gpio.h"
#include "Drivers/dma_drv.h"
#include "Drivers/FTM.h"
#include "Drivers/port.h"


#include "EventQueue/queue.h"
#include "FSM/FSM.h"

/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/

/*******************************************************************************
 * FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS WITH FILE LEVEL SCOPE
 ******************************************************************************/
void changeDuty (void);

/*******************************************************************************
 * VARIABLE PROTOTYPES WITH GLOBAL SCOPE
 ******************************************************************************/
uint32_t duty = 190;
uint32_t period = 379;

uint16_t sourceBuffer[] = {1000 ,2000,3000,4000,5000,6000,7000,8000};
uint16_t sine[] = {
		190,191,193,195,197,199,200,202,
		204,206,208,209,211,213,215,216,
		218,220,222,224,225,227,229,231,
		232,234,236,238,239,241,243,245,
		246,248,250,251,253,255,257,258,
		260,262,263,265,267,268,270,271,
		273,275,276,278,280,281,283,284,
		286,287,289,290,292,293,295,296,
		298,299,301,302,304,305,307,308,
		309,311,312,314,315,316,318,319,
		320,322,323,324,325,327,328,329,
		330,332,333,334,335,336,337,338,
		340,341,342,343,344,345,346,347,
		348,349,350,351,352,353,354,355,
		355,356,357,358,359,360,360,361,
		362,363,363,364,365,365,366,367,
		367,368,369,369,370,370,371,371,
		372,372,373,373,374,374,374,375,
		375,376,376,376,377,377,377,377,
		378,378,378,378,378,378,379,379,
		379,379,379,379,379,379,379,379,
		379,379,379,379,379,378,378,378,
		378,378,378,377,377,377,377,376,
		376,376,375,375,374,374,374,373,
		373,372,372,371,371,370,370,369,
		369,368,367,367,366,365,365,364,
		363,363,362,361,360,360,359,358,
		357,356,355,355,354,353,352,351,
		350,349,348,347,346,345,344,343,
		342,341,340,338,337,336,335,334,
		333,332,330,329,328,327,325,324,
		323,322,320,319,318,316,315,314,
		312,311,309,308,307,305,304,302,
		301,299,298,296,295,293,292,290,
		289,287,286,284,283,281,280,278,
		276,275,273,271,270,268,267,265,
		263,262,260,258,257,255,253,251,
		250,248,246,245,243,241,239,238,
		236,234,232,231,229,227,225,224,
		222,220,218,216,215,213,211,209,
		208,206,204,202,200,199,197,195,
		193,191,190,188,186,184,182,180,
		179,177,175,173,171,170,168,166,
		164,163,161,159,157,155,154,152,
		150,148,147,145,143,141,140,138,
		136,134,133,131,129,128,126,124,
		122,121,119,117,116,114,112,111,
		109,108,106,104,103,101,99,98,
		96,95,93,92,90,89,87,86,
		84,83,81,80,78,77,75,74,
		72,71,70,68,67,65,64,63,
		61,60,59,57,56,55,54,52,
		51,50,49,47,46,45,44,43,
		42,41,39,38,37,36,35,34,
		33,32,31,30,29,28,27,26,
		25,24,24,23,22,21,20,19,
		19,18,17,16,16,15,14,14,
		13,12,12,11,10,10,9,9,
		8,8,7,7,6,6,5,5,
		5,4,4,3,3,3,2,2,
		2,2,1,1,1,1,1,1,
		0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,1,
		1,1,1,1,1,2,2,2,
		2,3,3,3,4,4,5,5,
		5,6,6,7,7,8,8,9,
		9,10,10,11,12,12,13,14,
		14,15,16,16,17,18,19,19,
		20,21,22,23,24,24,25,26,
		27,28,29,30,31,32,33,34,
		35,36,37,38,39,41,42,43,
		44,45,46,47,49,50,51,52,
		54,55,56,57,59,60,61,63,
		64,65,67,68,70,71,72,74,
		75,77,78,80,81,83,84,86,
		87,89,90,92,93,95,96,98,
		99,101,103,104,106,108,109,111,
		112,114,116,117,119,121,122,124,
		126,128,129,131,133,134,136,138,
		140,141,143,145,147,148,150,152,
		154,155,157,159,161,163,164,166,
		168,170,171,173,175,177,179,180,
		182,184,186,188
};

/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/


/* Función que se llama 1 vez, al comienzo del programa */
void App_Init (void)
{

	PORT_Init();
	FTM_Init(FTM_0, FTM_PSC_x1, 0xFFFF, 0);
    FTM_CH_PWM_Init(FTM_0, FTM_CH_0, FTM_PWM_HIGH_PULSES, FTM_PWM_EDGE_ALIGNED, duty, period,NULL);		//90% duty cycle (en hexa)
    FTM_CH_EnableDMA(FTM_0, FTM_CH_0);

    volatile uint32_t * CnV_pointer = FTM_CH_GetCnVPointer(FTM_0, FTM_CH_0);		// le agregue el volatile pa que no tire el warning
	dma0_init(FTM0CH0, 0, (uint32_t)sine, (uint32_t) CnV_pointer, 2, 0, 2, 2, sizeof(sine), sizeof(sine), 0);
	FTM_CH_EnableDMA(FTM_0, FTM_CH_0);

    FTM_Restart(FTM_0);
    FTM_PWM_ON(FTM_0,FTM_CH_0);
}

/* Función que se llama constantemente en un ciclo infinito */
void App_Run (void)
{

}

// esta funcion se ejecuta cuando termina un período de FTM, va rotando de duty (solo pa testear)
void changeDuty (void)
{
	FTM_PWM_SetDuty(FTM_0,FTM_CH_0,(FTM_CH_GetCount(FTM_0,FTM_CH_0)+1)%(period));
}


/*******************************************************************************
 *******************************************************************************
                        LOCAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/



/*******************************************************************************
 ******************************************************************************/
